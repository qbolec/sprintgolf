<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <style>
      *{
        box-sizing:border-box;
      }
      body {
        margin:0;
        padding:0;
        background: brown;
      }
      #desktop{
        position: relative;;
        height:600px;  
        width:800px;  
      }
      #preview,
      #photo{
        position: absolute;
        height:100%;  
        width:100%;  
        top:0px;
        left:0px;
      }
      #photo{
        /*display: none;*/
      }
    </style>
  </head>
  <body>
    <div id="desktop">
      <img id="photo" src="labirynt Hugo.jpg"/>
      <canvas id="preview" width="800" height="600"/>
    </div>
    <label for="rows">rows:</label><input type=number id="rows" value=25>
    <label for="columns">columns:</label><input type=number id="columns" value=38>
    <span id="status"></span>
  </body>
  <script type="text/javascript" src="lib.js"></script>
  <script type="text/javascript">

const photo = document.getElementById('photo');
const preview = document.getElementById('preview');
const ctx = preview.getContext('2d');
function drawDot(color,p){
  ctx.strokeStyle=color;
  ctx.beginPath();
  ctx.rect(p.x-1, p.y-1,3,3);
  ctx.stroke();
}
function analyze(){
  ctx.drawImage(
    photo, 
    0, 0, photo.width, photo.height
  );
  const imageData=ctx.getImageData(0,0,preview.width,preview.height);
  const data = imageData.data;
  const cloned = new Uint8ClampedArray(data);
  const get = (x,y) => {
    const pos=y*preview.width*4+4*x;
    const colors = [cloned[pos+0],cloned[pos+1],cloned[pos+2]]
    return colors;
  }
  const WX = [
    [-1, 0, 1],
    [-2, 0, 2],
    [-1, 0, 1],
  ];
  const WY = WX.map((row,i)=>row.map((v,j)=>WX[j][i]))
  const W=[WX,WY];
  const es = [];
  for(let y=1;y+1<preview.height;++y){
    for(let x=1;x+1<preview.width;++x){
      const pos=(y*preview.width+x)*4;
      let L=[[0,0,0],[0,0,0]];
      for(let dx=-1;dx<=1;++dx){
        for(let dy=-1;dy<=1;++dy){
          const n=get(x+dx,y+dy);
          W.forEach((w,i)=>{
            const s=w[1+dy][1+dx];
            n.forEach((v,j)=> {L[i][j]+=s*v})
          })
        }
      }
      const e = max(L[0].map((l,i)=> Math.sqrt(l**2+L[1][i]**2)) );
      es.push(e);
      for(let i=0;i<3;++i){
        data[pos+i]=e;
      }
    }
  }
  const threshold = split(es).threshold;
  for(let y=1;y+1<preview.height;++y){
    for(let x=1;x+1<preview.width;++x){
      const pos=(y*preview.width+x)*4;
      for(let i=0;i<3;++i){
        data[pos+i]=data[pos+i]>threshold?255:0;
      } 
    }
  }
  let todo=[];
  for(let y=preview.height>>2;y<preview.height*3>>2;++y){
    for(let x=preview.width>>2;x<preview.width*3>>2;++x){
      const pos=(y*preview.width+x)*4;
      if(data[pos+0]){
        data[pos+1]=0;
        todo.push({x,y});
      }
    }
  }

  while(todo.length){
    const {x,y}=todo.pop();
    for(let dx=-2;dx<=2;++dx){
      const x2=x+dx;
      if(0<=x2 && x2<preview.width){
        for(let dy=-2;dy<=2;++dy){
          const y2=y+dy;
          if(0<=y2 && y2<preview.height){
            const pos=(y2*preview.width+x2)*4;
            if(data[pos+0]&&data[pos+1]){
              data[pos+1]=0;
              todo.push({x:x2,y:y2});
            }
          }
        }
      }
    }
  }
  ctx.putImageData(imageData,0,0)
}
photo.addEventListener('load',()=>{
  analyze();
})
  </script>
</html>