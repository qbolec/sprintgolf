<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <style>
      *{
        box-sizing:border-box;
      }
      body {
        margin:0;
        padding:0;
        background: brown;
      }
      #desktop{
        position: relative;;
        height:600px;  
        width:800px;  
      }
      #preview,
      #photo{
        position: absolute;
        height:100%;  
        width:100%;  
        top:0px;
        left:0px;
      }
      #photo{
        /*display: none;*/
      }
    </style>
  </head>
  <body>
    <div id="desktop">
      <img id="photo" src="labirynt Hugo.jpg"/>
      <canvas id="preview" width="800" height="600"/>
    </div>
    <label for="rows">rows:</label><input type=number id="rows" value=25>
    <label for="columns">columns:</label><input type=number id="columns" value=38>
    <span id="status"></span>
  </body>
  <script type="text/javascript">

const photo = document.getElementById('photo');
const preview = document.getElementById('preview');
const ctx = preview.getContext('2d');
function drawDot(color,p){
  ctx.strokeStyle=color;
  ctx.beginPath();
  ctx.rect(p.x-1, p.y-1,3,3);
  ctx.stroke();
}
function analyze(){
  ctx.drawImage(
    photo, 
    0, 0, photo.width, photo.height
  );
  const imageData=ctx.getImageData(0,0,preview.width,preview.height);
  const data = imageData.data;
  const cloned = new Uint8ClampedArray(data);
  const get = (x,y) => {
    const pos=y*preview.width*4+4*x;
    const colors = [cloned[pos+0],cloned[pos+1],cloned[pos+2]]
    return colors;
  }
  const WX = [
    [-1, 0, 1],
    [-2, 0, 2],
    [-1, 0, 1],
  ];
  const WY = WX.map((row,i)=>row.map((v,j)=>WX[j][i]))
  const W=[WX,WY];
  for(let y=1;y+1<preview.height;++y){
    for(let x=1;x+1<preview.width;++x){
      const pos=(y*preview.width+x)*4;
      let L=[[0,0,0],[0,0,0]];
      for(let dx=-1;dx<=1;++dx){
        for(let dy=-1;dy<=1;++dy){
          const n=get(x+dx,y+dy);
          const avg=n.reduce((a,b)=>a+b)/3;

          W.forEach((w,i)=>{
            const s=w[1+dy][1+dx];
            n.forEach((v,j)=> {L[i][j]+=s*avg})
          })
        }
      }
      for(let i=0;i<3;++i){
        data[pos+i]=Math.sqrt(L[0][i]**2+L[1][i]**2);
      }
    }
  }
  ctx.putImageData(imageData,0,0)
}
photo.addEventListener('load',()=>{
  analyze();
})
  </script>
</html>